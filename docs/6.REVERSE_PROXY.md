# üîí Reverse Proxy & HTTPS Setup

This guide explains how to deploy MyAstroBoard behind a reverse proxy (like NGINX Proxy Manager, Traefik, or Apache) with HTTPS termination.

## Overview

In a typical production deployment:
- **Reverse Proxy** (NGINX Proxy Manager, Traefik, etc.) handles HTTPS/SSL on port 443
- **MyAstroBoard** runs in Docker on HTTP (e.g., port 5000)
- The reverse proxy forwards requests to MyAstroBoard via HTTP internally

## The Challenge

When using `SESSION_COOKIE_SECURE=true`, Flask sets the `Secure` flag on session cookies, which instructs browsers to only send the cookie over HTTPS connections. However, if Flask doesn't know the original request was HTTPS (because it only sees HTTP from the proxy), cookies and sessions may not work correctly.

### The Solution: ProxyFix Middleware

MyAstroBoard includes support for the ProxyFix middleware, which allows Flask to trust proxy headers sent by the reverse proxy. This is **required** for proper HTTPS operation.

---

## Configuration

### Step 1: Update docker-compose.yml

Add these environment variables to your `docker-compose.yml`:

```yaml
services:
  myastroboard:
    image: ghcr.io/worldofgz/myastroboard:latest
    container_name: myastroboard
    environment:
      # CRITICAL: Enable proxy header trust for HTTPS termination
      - TRUST_PROXY_HEADERS=true
      
      # Enable secure cookies (HTTPS only)
      - SESSION_COOKIE_SECURE=true
      
      # IMPORTANT: Set a persistent secret key for sessions
      # Generate with: openssl rand -hex 32
      - SECRET_KEY=your-random-secret-key-here
      
      # Other settings...
      - TZ=America/New_York
      - DATA_DIR=/app/data
    ports:
      - "5000:5000"  # Internal port - NOT exposed to internet
    volumes:
      - ./data:/app/data
      - ./uptonight_outputs:/app/uptonight_outputs
    restart: unless-stopped
```

### Step 2: Configure Your Reverse Proxy

Your reverse proxy **must** send the following headers to MyAstroBoard:

#### Required Headers:
- `X-Forwarded-Proto: https` (tells Flask the original request was HTTPS)
- `X-Forwarded-For: <client-ip>` (preserves client IP for logging)
- `X-Forwarded-Host: <your-domain>` (original hostname)
- `X-Forwarded-Port: 443` (original port)

---

## Reverse Proxy Examples

### NGINX Proxy Manager (NPM)

#### NPM Configuration

1. **Create Proxy Host** in NGINX Proxy Manager:
   - **Domain Names**: `myastroboard.yourdomain.com`
   - **Scheme**: `http`
   - **Forward Hostname/IP**: Your Docker host IP or container name
   - **Forward Port**: `5000`
   - **Cache Assets**: ‚úÖ Enabled (recommended)
   - **Block Common Exploits**: ‚úÖ Enabled
   - **Websockets Support**: ‚úÖ Enabled (if using any websocket features)

2. **SSL Tab**:
   - **SSL Certificate**: Select or create Let's Encrypt certificate
   - **Force SSL**: ‚úÖ Enabled
   - **HTTP/2 Support**: ‚úÖ Enabled
   - **HSTS Enabled**: ‚úÖ Enabled (recommended)

3. **Advanced Tab** (add this):
```nginx
# Proxy headers for Flask ProxyFix
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Host $host;
proxy_set_header X-Forwarded-Port $server_port;
proxy_set_header X-Forwarded-Prefix /;

# Standard proxy headers
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;

# Timeouts (adjust if needed)
proxy_connect_timeout 60s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;
```

#### Docker Compose for NPM + MyAstroBoard

If running NPM and MyAstroBoard on the same Docker host:

```yaml
version: '3.8'

services:
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    ports:
      - "80:80"
      - "443:443"
      - "81:81"  # NPM Admin UI
    volumes:
      - ./npm/data:/data
      - ./npm/letsencrypt:/etc/letsencrypt
    restart: unless-stopped
    networks:
      - proxy-network

  myastroboard:
    image: ghcr.io/worldofgz/myastroboard:latest
    container_name: myastroboard
    environment:
      - TRUST_PROXY_HEADERS=true
      - SESSION_COOKIE_SECURE=true
      - SECRET_KEY=${SECRET_KEY}
      - TZ=America/New_York
    # Don't expose port 5000 externally - NPM will proxy to it
    expose:
      - "5000"
    volumes:
      - ./myastroboard/data:/app/data
      - ./myastroboard/uptonight_outputs:/app/uptonight_outputs
    restart: unless-stopped
    networks:
      - proxy-network

networks:
  proxy-network:
    driver: bridge
```

In NPM, use `myastroboard` as the Forward Hostname (Docker service name) and `5000` as the port.

---

### Traefik

#### docker-compose.yml with Traefik

```yaml
version: '3.8'

services:
  myastroboard:
    image: ghcr.io/worldofgz/myastroboard:latest
    container_name: myastroboard
    environment:
      - TRUST_PROXY_HEADERS=true
      - SESSION_COOKIE_SECURE=true
      - SECRET_KEY=${SECRET_KEY}
      - TZ=America/New_York
    expose:
      - "5000"
    volumes:
      - ./data:/app/data
      - ./uptonight_outputs:/app/uptonight_outputs
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.myastroboard.rule=Host(`myastroboard.yourdomain.com`)"
      - "traefik.http.routers.myastroboard.entrypoints=websecure"
      - "traefik.http.routers.myastroboard.tls=true"
      - "traefik.http.routers.myastroboard.tls.certresolver=letsencrypt"
      - "traefik.http.services.myastroboard.loadbalancer.server.port=5000"
    networks:
      - traefik-network

networks:
  traefik-network:
    external: true
```

Traefik automatically adds the required `X-Forwarded-*` headers.

---

### Standard NGINX

If using standalone NGINX (not NPM):

```nginx
server {
    listen 443 ssl http2;
    server_name myastroboard.yourdomain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:5000;
        
        # Required headers for ProxyFix
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # Standard headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # WebSocket support (if needed)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name myastroboard.yourdomain.com;
    return 301 https://$server_name$request_uri;
}
```

---

### Apache

```apache
<VirtualHost *:443>
    ServerName myastroboard.yourdomain.com
    
    SSLEngine on
    SSLCertificateFile /path/to/cert.pem
    SSLCertificateKeyFile /path/to/key.pem
    
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/
</VirtualHost>

<VirtualHost *:80>
    ServerName myastroboard.yourdomain.com
    Redirect permanent / https://myastroboard.yourdomain.com/
</VirtualHost>
```

---

## Environment Variables Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `TRUST_PROXY_HEADERS` | **Yes** (for reverse proxy) | `false` | Enable ProxyFix middleware to trust X-Forwarded headers |
| `SESSION_COOKIE_SECURE` | **Yes** (for HTTPS) | `false` | Set Secure flag on cookies (HTTPS only) |
| `SECRET_KEY` | **Highly Recommended** | Random | Persistent secret for session encryption. Generate with `openssl rand -hex 32` |
| `SESSION_COOKIE_SAMESITE` | No | `Lax` | Cookie SameSite policy |

---

## Testing Your Setup

### 1. Verify HTTPS is Working
```bash
curl -I https://myastroboard.yourdomain.com
```
Should return `HTTP/2 200` or `HTTP/1.1 200 OK`

### 2. Check Secure Cookies
In browser DevTools (Network tab), inspect the response headers for `/api/auth/login`:
- Look for `Set-Cookie` header
- Should include `Secure; HttpOnly; SameSite=Lax`

### 3. Test Remember Me Feature
1. Login with "Remember me" checked
2. Close browser completely
3. Reopen and navigate to your MyAstroBoard URL
4. Should automatically be logged in

### 4. Check Logs
In MyAstroBoard logs:
```bash
docker logs myastroboard
```

You should see:
```
ProxyFix middleware enabled - trusting X-Forwarded-* headers from reverse proxy
Successful login for user admin (remember_me: True, permanent_session: True)
Session restored from cookie for user admin (permanent: True, endpoint: index)
```

---

## Troubleshooting

### ‚ùå "Authentication required" after login with HTTPS

**Cause**: ProxyFix not enabled or proxy not sending `X-Forwarded-Proto: https`

**Solution**: 
1. Set `TRUST_PROXY_HEADERS=true` in docker-compose.yml
2. Verify proxy is sending `X-Forwarded-Proto: https` header
3. Restart MyAstroBoard container

### ‚ùå Cookies not persisting after browser restart

**Cause**: `SESSION_COOKIE_SECURE=true` but site accessed via HTTP

**Solution**: Always access via HTTPS when `SESSION_COOKIE_SECURE=true`

### ‚ùå Sessions invalidated after container restart

**Cause**: No persistent `SECRET_KEY` set

**Solution**: Generate and set a persistent secret:
```bash
openssl rand -hex 32
```
Add to docker-compose.yml:
```yaml
environment:
  - SECRET_KEY=your-generated-key-here
```

### ‚ùå IP addresses in logs show proxy IP, not client IP

**Cause**: ProxyFix not enabled

**Solution**: Set `TRUST_PROXY_HEADERS=true`

---

## Security Best Practices

1. ‚úÖ **Always use HTTPS in production** with valid SSL certificates
2. ‚úÖ **Set a strong, persistent SECRET_KEY** (generate with `openssl rand -hex 32`)
3. ‚úÖ **Enable TRUST_PROXY_HEADERS** only when behind a trusted reverse proxy
4. ‚úÖ **Use SESSION_COOKIE_SECURE=true** for HTTPS deployments
5. ‚úÖ **Keep Docker images updated** (`docker compose pull`)
6. ‚úÖ **Use environment variables** for sensitive configuration (don't commit secrets)
7. ‚úÖ **Enable firewall rules** to restrict direct access to port 5000
8. ‚ö†Ô∏è **Never expose port 5000 directly to the internet** when using a reverse proxy

---

## Quick Reference

### Development (Local, HTTP)
```yaml
environment:
  - TRUST_PROXY_HEADERS=false
  - SESSION_COOKIE_SECURE=false
```

### Production (Reverse Proxy, HTTPS)
```yaml
environment:
  - TRUST_PROXY_HEADERS=true
  - SESSION_COOKIE_SECURE=true
  - SECRET_KEY=your-random-secret-key-here
```

---

## Additional Resources

- [NGINX Proxy Manager Documentation](https://nginxproxymanager.com/guide/)
- [Traefik Documentation](https://doc.traefik.io/traefik/)
- [Werkzeug ProxyFix Documentation](https://werkzeug.palletsprojects.com/en/latest/middleware/proxy_fix/)
- [Flask Session Configuration](https://flask.palletsprojects.com/en/latest/config/#sessions)
