"""
UpTonight output parser
Parses JSON reports generated by UpTonight
"""
import os
import json
from typing import Dict, List, Optional
from logging_config import get_logger

# Initialize logger for this module
logger = get_logger(__name__)

def parse_uptonight_report(file_path: str, report_type: str, catalogue_dir: str) -> Optional[Dict]:
    """
    Parse UpTonight JSON report file
    Returns parsed data or None if file doesn't exist or is invalid
    """
    try:
        if not os.path.exists(file_path):
            return None
        
        with open(file_path, 'r') as f:
            data = json.load(f)
        
        if report_type == 'objects':
            return parse_objects_report(data, catalogue_dir)
        elif report_type == 'comets':
            return parse_comets_report(data, catalogue_dir)
        elif report_type == 'bodies':
            return parse_bodies_report(data, catalogue_dir)
        else:
            return {'type': 'unknown', 'raw': data}
    
    except Exception as e:
        logger.error(f"Error parsing UpTonight report {file_path}: {e}")
        return None


def parse_objects_report(data: Dict, catalogue_dir: str) -> Dict:
    """Parse objects (targets) report into list of objects"""
    objects = []
    
    # Get number of entries
    if 'id' not in data:
        return {'type': 'objects', 'objects': []}
    
    num_entries = len(data['id'])
    
    for i in range(num_entries):
        obj = {}
        for key, values in data.items():
            if str(i) in values:
                # Add a new key (alttime_file) for Alttime compatibility
                if key == 'id':
                    obj['alttime_file'] = get_alttime_file_name(values[str(i)], catalogue_dir)
                obj[key] = values[str(i)]
        objects.append(obj)
    
    return {
        'type': 'objects',
        'count': len(objects),
        'objects': objects
    }


def parse_comets_report(data: Dict, catalogue_dir: str) -> Dict:
    """Parse comets report into list of comets"""
    comets = []
    
    if 'target name' not in data:
        return {'type': 'comets', 'comets': []}
    
    num_entries = len(data['target name'])
    
    for i in range(num_entries):
        comet = {}
        for key, values in data.items():
            if str(i) in values:
                # Add a new key (alttime_file) for Alttime compatibility
                if key == 'target name':
                    comet['alttime_file'] = get_alttime_file_name(values[str(i)], catalogue_dir)
                comet[key] = values[str(i)]
        comets.append(comet)
    
    return {
        'type': 'comets',
        'count': len(comets),
        'comets': comets
    }


def parse_bodies_report(data: Dict, catalogue_dir: str) -> Dict:
    """Parse bodies (planets/moon) report into list of bodies"""
    bodies = []
    
    if 'target name' not in data:
        return {'type': 'bodies', 'bodies': []}
    
    num_entries = len(data['target name'])
    
    for i in range(num_entries):
        body = {}
        for key, values in data.items():
            if str(i) in values:
                # Add a new key (alttime_file) for Alttime compatibility
                if key == 'target name':
                    body['alttime_file'] = get_alttime_file_name(values[str(i)], catalogue_dir)
                body[key] = values[str(i)]
        bodies.append(body)
    
    return {
        'type': 'bodies',
        'count': len(bodies),
        'bodies': bodies
    }


def get_catalogue_reports(catalogue_dir: str) -> Dict:
    """
    Get all available reports for a target
    Returns dictionary with report types and their data
    """
    reports = {}
    
    if not os.path.exists(catalogue_dir):
        return reports
    
    # UpTonight output file names
    report_files = {
        'objects': 'uptonight-report.json',
        'comets': 'uptonight-comets-report.json',
        'bodies': 'uptonight-bodies-report.json',
        'plot': 'uptonight-plot.png'
    }
    
    for report_type, filename in report_files.items():
        file_path = os.path.join(catalogue_dir, filename)
        
        if filename.endswith('.json'):
            parsed = parse_uptonight_report(file_path, report_type, catalogue_dir)
            if parsed:
                reports[report_type] = parsed
        elif os.path.exists(file_path):
            # Just mark that the file exists
            reports[report_type] = {'available': True, 'path': filename}
    
    return reports


def format_value(key: str, value) -> str:
    """Format values for display"""
    if value is None or value == '':
        return 'N/A'
    
    # Handle numeric formatting
    if isinstance(value, (int, float)):
        # Foto is a percentage
        if key == 'foto':
            return f"{value * 100:.1f}%"
        # Magnitudes
        elif key in ['mag', 'visual magnitude', 'absolute magnitude']:
            return f"{value:.2f}"
        # Coordinates
        elif key in ['right ascension', 'declination', 'altitude', 'azimuth']:
            return f"{value:.2f}Â°"
        # Distances
        elif 'distance' in key.lower():
            return f"{value:.3f} AU"
        # Sizes
        elif key == 'size':
            return f"{value:.1f}'"
        else:
            return str(value)
    
    return str(value)


def sanitize_alttime_target_name(name: str) -> str:
    """Sanitize target name for Alttime compatibility"""
    sanitized = name.lower().replace(' ', '-').replace('/', '-').replace('\\', '-')
    return sanitized


def get_alttime_file_name(target_name: str, catalogue_dir: str) -> str:
    """
    Generate Alttime-compatible file name from target name
    Return file name if exists, else empty string
    """
    sanitized = sanitize_alttime_target_name(target_name)

    file = os.path.join(catalogue_dir, f"uptonight-alttime-{sanitized}.png")
    if os.path.exists(file):
        return f"uptonight-alttime-{sanitized}.png"
    else:
        return ""